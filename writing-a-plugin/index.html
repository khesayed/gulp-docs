<!DOCTYPE HTML><html lang=""><head><title>Writing a Plugin &#xB7; Gulp Documentation</title><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta name="description" content=""><meta name="generator" content="GitBook 3.2.0"><link rel="stylesheet" href="../gitbook/style.css"><link rel="stylesheet" href="../gitbook/plugins.css"><meta name="HandheldFriendly" content="true"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png"><link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon"><link rel="next" href="guidelines.html"><link rel="prev" href="../CLI.html"></head><body><div class="book"><div class="book-summary"><div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div><nav role="navigation"><ul class="summary"><li class="chapter" data-level="1.1" data-path="../"><a href="../">Introduction</a></li><li class="chapter" data-level="1.2" data-path="../getting-started.html"><a href="../getting-started.html">Getting Started</a></li><li class="chapter" data-level="1.3" data-path="../API.html"><a href="../API.html">API</a></li><li class="chapter" data-level="1.4" data-path="../CLI.html"><a href="../CLI.html">CLI</a></li><li class="chapter active" data-level="1.5" data-path="./"><a href="./">Writing a Plugin</a><ul class="articles"><li class="chapter" data-level="1.5.1" data-path="guidelines.html"><a href="guidelines.html">Guidelines</a></li><li class="chapter" data-level="1.5.2" data-path="using-buffers.html"><a href="using-buffers.html">Using buffers</a></li><li class="chapter" data-level="1.5.3" data-path="dealing-with-streams.html"><a href="dealing-with-streams.html">Dealing with streams</a></li><li class="chapter" data-level="1.5.4" data-path="testing.html"><a href="testing.html">Testing</a></li><li class="chapter" data-level="1.5.5" data-path="recommended-modules.html"><a href="recommended-modules.html">Recommended Modules</a></li></ul></li><li class="chapter" data-level="1.6" data-path="../FAQ.html"><a href="../FAQ.html">FAQ</a></li><li class="chapter" data-level="1.7" data-path="../recipes/"><a href="../recipes/">Recipes</a><ul class="articles"><li class="chapter" data-level="1.7.1" data-path="../recipes/automate-release-workflow.html"><a href="../recipes/automate-release-workflow.html">Automate release workflow</a></li><li class="chapter" data-level="1.7.2" data-path="../recipes/combining-streams-to-handle-errors.html"><a href="../recipes/combining-streams-to-handle-errors.html">Combining streams to handle errors</a></li><li class="chapter" data-level="1.7.3" data-path="../recipes/delete-files-folder.html"><a href="../recipes/delete-files-folder.html">Delete files and folders</a></li><li class="chapter" data-level="1.7.4" data-path="../recipes/fast-browserify-builds-with-watchify.html"><a href="../recipes/fast-browserify-builds-with-watchify.html">Fast browserify builds with watchify</a></li><li class="chapter" data-level="1.7.5" data-path="../recipes/incremental-builds-with-concatenate.html"><a href="../recipes/incremental-builds-with-concatenate.html">Incremental rebuilding, including operating on full file sets</a></li><li class="chapter" data-level="1.7.6" data-path="../recipes/make-stream-from-buffer.html"><a href="../recipes/make-stream-from-buffer.html">Make stream from buffer (memory contents)</a></li><li class="chapter" data-level="1.7.7" data-path="../recipes/mocha-test-runner-with-gulp.html"><a href="../recipes/mocha-test-runner-with-gulp.html">Mocha test-runner with gulp</a></li><li class="chapter" data-level="1.7.8" data-path="../recipes/only-pass-through-changed-files.html"><a href="../recipes/only-pass-through-changed-files.html">Only pass through changed files</a></li><li class="chapter" data-level="1.7.9" data-path="../recipes/pass-arguments-from-cli.html"><a href="../recipes/pass-arguments-from-cli.html">Pass parameters from the command line</a></li><li class="chapter" data-level="1.7.10" data-path="../recipes/rebuild-only-files-that-change.html"><a href="../recipes/rebuild-only-files-that-change.html">Rebuild only files that change</a></li><li class="chapter" data-level="1.7.11" data-path="../recipes/running-task-steps-per-folder.html"><a href="../recipes/running-task-steps-per-folder.html">Generating a file per folder</a></li><li class="chapter" data-level="1.7.12" data-path="../recipes/running-tasks-in-series.html"><a href="../recipes/running-tasks-in-series.html">Running tasks in series</a></li><li class="chapter" data-level="1.7.13" data-path="../recipes/server-with-livereload-and-css-injection.html"><a href="../recipes/server-with-livereload-and-css-injection.html">Server with live-reloading and CSS injection</a></li><li class="chapter" data-level="1.7.14" data-path="../recipes/sharing-streams-with-stream-factories.html"><a href="../recipes/sharing-streams-with-stream-factories.html">Sharing streams with stream factories</a></li><li class="chapter" data-level="1.7.15" data-path="../recipes/specifying-a-cwd.html"><a href="../recipes/specifying-a-cwd.html">Specifying a new cwd (current working directory)</a></li><li class="chapter" data-level="1.7.16" data-path="../recipes/split-tasks-across-multiple-files.html"><a href="../recipes/split-tasks-across-multiple-files.html">Split tasks across multiple files</a></li><li class="chapter" data-level="1.7.17" data-path="../recipes/using-external-config-file.html"><a href="../recipes/using-external-config-file.html">Using external config file</a></li><li class="chapter" data-level="1.7.18" data-path="../recipes/using-multiple-sources-in-one-task.html"><a href="../recipes/using-multiple-sources-in-one-task.html">Using multiple sources in one task</a></li><li class="chapter" data-level="1.7.19" data-path="../recipes/browserify-transforms.html"><a href="../recipes/browserify-transforms.html">Browserify + Transforms</a></li><li class="chapter" data-level="1.7.20" data-path="../recipes/browserify-uglify-sourcemap.html"><a href="../recipes/browserify-uglify-sourcemap.html">Browserify + Uglify with sourcemaps</a></li><li class="chapter" data-level="1.7.21" data-path="../recipes/browserify-with-globs.html"><a href="../recipes/browserify-with-globs.html">Browserify + Globs</a></li><li class="chapter" data-level="1.7.22" data-path="../recipes/browserify-multiple-destination.html"><a href="../recipes/browserify-multiple-destination.html">Browserify + Globs (multiple destination)</a></li><li class="chapter" data-level="1.7.23" data-path="../recipes/minified-and-non-minified.html"><a href="../recipes/minified-and-non-minified.html">Output both a minified and non-minified version</a></li><li class="chapter" data-level="1.7.24" data-path="../recipes/templating-with-swig-and-yaml-front-matter.html"><a href="../recipes/templating-with-swig-and-yaml-front-matter.html">Templating with Swig and YAML front-matter</a></li><li class="chapter" data-level="1.7.25" data-path="../recipes/handling-the-delete-event-on-watch.html"><a href="../recipes/handling-the-delete-event-on-watch.html">Handling the Delete Event on Watch</a></li><li class="chapter" data-level="1.7.26" data-path="../recipes/maintain-directory-structure-while-globbing.html"><a href="../recipes/maintain-directory-structure-while-globbing.html">Maintain Directory Structure while Globbing</a></li><li class="chapter" data-level="1.7.27" data-path="../recipes/run-grunt-tasks-from-gulp.html"><a href="../recipes/run-grunt-tasks-from-gulp.html">Run Grunt Tasks from Gulp</a></li><li class="chapter" data-level="1.7.28" data-path="../recipes/exports-as-tasks.html"><a href="../recipes/exports-as-tasks.html">Exports as tasks</a></li><li class="chapter" data-level="1.7.29" data-path="../recipes/rollup-with-rollup-stream.html"><a href="../recipes/rollup-with-rollup-stream.html">Rollup with rollup-stream</a></li></ul></li><li class="divider"></li><li><a href="https://www.gitbook.com" target="blank" class="gitbook-link">Published with GitBook</a></li></ul></nav></div><div class="book-body"><div class="body-inner"><div class="book-header" role="navigation"><!-- Title --><h1><i class="fa fa-circle-o-notch fa-spin"></i> <a href="..">Writing a Plugin</a></h1></div><div class="page-wrapper" tabindex="-1" role="main"><div class="page-inner"><div id="book-search-results"><div class="search-noresults"><section class="normal markdown-section"><h1 id="writing-a-plugin">Writing a plugin</h1><p>If you plan to create your own Gulp plugin, you will save time by reading the full documentation.</p><ul><li><a href="guidelines.html">Guidelines</a> (a MUST read)</li><li><a href="using-buffers.html">Using buffers</a></li><li><a href="dealing-with-streams.html">Dealing with streams</a></li><li><a href="testing.html">Testing</a></li></ul><h2 id="what-it-does">What it does</h2><h3 id="streaming-file-objects">Streaming file objects</h3><p>A gulp plugin always returns a stream in <a href="http://nodejs.org/api/stream.html#stream_object_mode" target="_blank">object mode</a> that does the following:</p><ol><li>Takes in <a href="http://github.com/gulpjs/vinyl" target="_blank">vinyl File objects</a></li><li>Outputs <a href="http://github.com/gulpjs/vinyl" target="_blank">vinyl File objects</a> (via <code>transform.push()</code> and/or the plugin&apos;s callback function)</li></ol><p>These are known as <a href="http://nodejs.org/api/stream.html#stream_class_stream_transform_1" target="_blank">transform streams</a> (also sometimes called through streams). Transform streams are streams that are readable and writable; they manipulate objects as they&apos;re being passed through.</p><p>All gulp plugins essentially boil down to this:</p><pre><code class="lang-js"><span class="hljs-keyword">var</span> Transform = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;transform&apos;</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// Monkey patch Transform or create your own subclass,</span>
  <span class="hljs-comment">// implementing `_transform()` and optionally `_flush()`</span>
  <span class="hljs-keyword">var</span> transformStream = <span class="hljs-keyword">new</span> Transform({objectMode: <span class="hljs-literal">true</span>});
  <span class="hljs-comment">/**
   * @param {Buffer|string} file
   * @param {string=} encoding - ignored if file contains a Buffer
   * @param {function(Error, object)} callback - Call this function (optionally with an
   *          error argument and data) when you are done processing the supplied chunk.
   */</span>
  transformStream._transform = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file, encoding, callback</span>) </span>{
    <span class="hljs-keyword">var</span> error = <span class="hljs-literal">null</span>,
        output = doSomethingWithTheFile(file);
    callback(error, output);
  };

  <span class="hljs-keyword">return</span> transformStream;
};</code></pre><p>Many plugins use the <a href="https://github.com/rvagg/through2/" target="_blank">through2</a> module to simplify their code:</p><pre><code class="lang-js"><span class="hljs-keyword">var</span> through = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;through2&apos;</span>);    <span class="hljs-comment">// npm install --save through2</span>

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> through.obj(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file, encoding, callback</span>) </span>{
    callback(<span class="hljs-literal">null</span>, doSomethingWithTheFile(file));
  });
};</code></pre><p>The stream returned from <code>through()</code> (and <code>this</code> within your transform function) is an instance of the <a href="https://github.com/iojs/readable-stream/blob/master/lib/_stream_transform.js" target="_blank">Transform</a> class, which extends <a href="https://github.com/iojs/readable-stream/blob/master/lib/_stream_duplex.js" target="_blank">Duplex</a>, <a href="https://github.com/iojs/readable-stream/blob/master/lib/_stream_readable.js" target="_blank">Readable</a> (and parasitically from Writable) and ultimately <a href="https://nodejs.org/api/stream.html" target="_blank">Stream</a>. If you need to parse additional options, you can call the <code>through()</code> function directly:</p><pre><code class="lang-js">  <span class="hljs-keyword">return</span> through({objectMode: <span class="hljs-literal">true</span> <span class="hljs-comment">/* other options... */</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file, encoding, callback</span>) </span>{ ...</code></pre><p>Supported options include:</p><ul><li>highWaterMark (defaults to 16)</li><li>defaultEncoding (defaults to &apos;utf8&apos;)</li><li>encoding - &apos;utf8&apos;, &apos;base64&apos;, &apos;utf16le&apos;, &apos;ucs2&apos; etc. If specified, a <a href="https://github.com/rvagg/string_decoder/blob/master/index.js" target="_blank">StringDecoder</a> <code>decoder</code> will be attached to the stream.</li><li>readable {boolean}</li><li>writable {boolean}</li><li>allowHalfOpen {boolean} If set to false, then the stream will automatically end the readable side when the writable side ends and vice versa.</li></ul><h3 id="modifying-file-content">Modifying file content</h3><p>The function parameter that you pass to <code>through.obj()</code> is a <a href="https://nodejs.org/api/stream.html#stream_transform_transform_chunk_encoding_callback" target="_blank">_transform</a> function which will operate on the input <code>file</code>. You may also provide an optional <a href="https://nodejs.org/api/stream.html#stream_transform_flush_callback" target="_blank">_flush</a> function if you need to emit a bit more data at the end of the stream.</p><p>From within your transform function call <code>this.push(file)</code> 0 or more times to pass along transformed/cloned files. You don&apos;t need to call <code>this.push(file)</code> if you provide all output to the <code>callback()</code> function.</p><p>Call the <code>callback</code> function only when the current file (stream/buffer) is completely consumed. If an error is encountered, pass it as the first argument to the callback, otherwise set it to null. If you have passed all output data to <code>this.push()</code> you can omit the second argument to the callback.</p><p>Generally, a gulp plugin would update <code>file.contents</code> and then choose to either:</p><ul><li>call <code>callback(null, file)</code> <em>or</em></li><li>make one call to <code>this.push(file)</code></li></ul><p>If a plugin creates multiple files from a single input file, it would make multiple calls to <code>this.push()</code> - eg:</p><pre><code class="lang-js"><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">/**
   * @this {Transform}
   */</span>
  <span class="hljs-keyword">var</span> transform = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file, encoding, callback</span>) </span>{
    <span class="hljs-keyword">var</span> files = splitFile(file);
    <span class="hljs-keyword">this</span>.push(files[<span class="hljs-number">0</span>]);
    <span class="hljs-keyword">this</span>.push(files[<span class="hljs-number">1</span>]);
    callback();
  };

  <span class="hljs-keyword">return</span> through.obj(transform);
};</code></pre><p>The <a href="https://github.com/suisho/gulp-unzip/blob/master/index.js" target="_blank">gulp-unzip</a> plugin provides a good example of making multiple calls to <code>push()</code>. It also uses a chunk transform stream with a <code>_flush()</code> function <em>within</em> the Vinyl transform function.</p><p>Vinyl files can have 3 possible forms for the contents attribute:</p><ul><li><a href="dealing-with-streams.html">Streams</a></li><li><a href="using-buffers.html">Buffers</a></li><li>Empty (null) - Useful for things like rimraf, clean, where contents is not needed.</li></ul><p>A simple example showing how to detect &amp; handle each form is provided below, for a more detailed explanation of each approach follow the links above.</p><pre><code class="lang-js"><span class="hljs-keyword">var</span> PluginError = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;gulp-util&apos;</span>).PluginError;

<span class="hljs-comment">// consts</span>
<span class="hljs-keyword">var</span> PLUGIN_NAME = <span class="hljs-string">&apos;gulp-example&apos;</span>;

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> through.obj(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file, encoding, callback</span>) </span>{
        <span class="hljs-keyword">if</span> (file.isNull()) {
            <span class="hljs-comment">// nothing to do</span>
            <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, file);
        }

        <span class="hljs-keyword">if</span> (file.isStream()) {
            <span class="hljs-comment">// file.contents is a Stream - https://nodejs.org/api/stream.html</span>
            <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">&apos;error&apos;</span>, <span class="hljs-keyword">new</span> PluginError(PLUGIN_NAME, <span class="hljs-string">&apos;Streams not supported!&apos;</span>));

            <span class="hljs-comment">// or, if you can handle Streams:</span>
            <span class="hljs-comment">//file.contents = file.contents.pipe(...</span>
            <span class="hljs-comment">//return callback(null, file);</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.isBuffer()) {
            <span class="hljs-comment">// file.contents is a Buffer - https://nodejs.org/api/buffer.html</span>
            <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">&apos;error&apos;</span>, <span class="hljs-keyword">new</span> PluginError(PLUGIN_NAME, <span class="hljs-string">&apos;Buffers not supported!&apos;</span>));

            <span class="hljs-comment">// or, if you can handle Buffers:</span>
            <span class="hljs-comment">//file.contents = ...</span>
            <span class="hljs-comment">//return callback(null, file);</span>
        }
    });
};</code></pre><p>Note: When looking through the code of other gulp plugins (and the example above), you may notice that the transform functions will return the result of the callback:</p><pre><code class="lang-js"><span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, file);</code></pre><p>...don&apos;t be confused - gulp ignores any return value of your transform function. The code above is simply a short-hand form of:</p><pre><code class="lang-js"><span class="hljs-keyword">if</span> (someCondition) {
  callback(<span class="hljs-literal">null</span>, file);
  <span class="hljs-keyword">return</span>;
}
<span class="hljs-comment">// further execution...</span></code></pre><h2 id="useful-resources">Useful resources</h2><ul><li><a href="https://github.com/gulpjs/gulp-util/#new-fileobj" target="_blank">File object</a></li><li><a href="https://github.com/gulpjs/gulp-util#new-pluginerrorpluginname-message-options" target="_blank">PluginError</a></li><li><a href="https://github.com/dominictarr/event-stream" target="_blank">event-stream</a></li><li><a href="https://github.com/nfroidure/BufferStream" target="_blank">BufferStream</a></li><li><a href="https://github.com/gulpjs/gulp-util" target="_blank">gulp-util</a></li></ul><h2 id="sample-plugins">Sample plugins</h2><ul><li><a href="https://github.com/search?q=%40sindresorhus+gulp-" target="_blank">sindresorhus&apos; gulp plugins</a></li><li><a href="https://github.com/search?q=%40contra+gulp-" target="_blank">contra&apos;s gulp plugins</a></li><li><a href="https://github.com/lazd/gulp-replace" target="_blank">gulp-replace</a></li></ul><h2 id="about-streams">About streams</h2><p>If you&apos;re unfamiliar with streams, you will need to read up on them:</p><ul><li><a href="https://github.com/substack/stream-handbook" target="_blank">https://github.com/substack/stream-handbook</a> (a MUST read)</li><li><a href="http://nodejs.org/api/stream.html" target="_blank">http://nodejs.org/api/stream.html</a></li></ul><p>Other libraries that are not file manipulating through streams but are made for use with gulp are tagged with the <a href="https://npmjs.org/browse/keyword/gulpfriendly" target="_blank">gulpfriendly</a> keyword on npm.</p></section></div><div class="search-results"><div class="has-results"><h1 class="search-results-title"><span class="search-results-count"></span> results matching &quot;<span class="search-query"></span>&quot;</h1><ul class="search-results-list"></ul></div><div class="no-results"><h1 class="search-results-title">No results matching &quot;<span class="search-query"></span>&quot;</h1></div></div></div></div></div></div><a href="../CLI.html" class="navigation navigation-prev" aria-label="Previous page: CLI"><i class="fa fa-angle-left"></i> </a><a href="guidelines.html" class="navigation navigation-next" aria-label="Next page: Guidelines"><i class="fa fa-angle-right"></i></a></div><script>var gitbook=gitbook||[];gitbook.push(function(){gitbook.page.hasChanged({page:{title:"Writing a Plugin",level:"1.5",depth:1,next:{title:"Guidelines",level:"1.5.1",depth:2,path:"writing-a-plugin/guidelines.md",ref:"writing-a-plugin/guidelines.md",articles:[]},previous:{title:"CLI",level:"1.4",depth:1,path:"CLI.md",ref:"CLI.md",articles:[]},dir:"ltr"},config:{plugins:["edit-link","ga","github","sitemap"],root:"./docs",styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"},pluginsConfig:{github:{url:"https://github.com/bipedd/gulp-docs"},search:{},lunr:{maxIndexSize:1e6,ignoreSpecialCharacters:!1},fontsettings:{theme:"white",family:"sans",size:2},highlight:{},sitemap:{hostname:"http://gulpjs.org/"},ga:{configuration:"auto",token:"UA-36637973-3"},sharing:{facebook:!1,twitter:!1,google:!1,weibo:!1,instapaper:!1,vk:!1,all:["facebook","google","twitter","weibo","instapaper"]},"edit-link":{label:"",base:"https://github.com/bipedd/gulp-docs/blob/master/docs"},"theme-default":{styles:{website:"styles/website.css",pdf:"styles/pdf.css",epub:"styles/epub.css",mobi:"styles/mobi.css",ebook:"styles/ebook.css",print:"styles/print.css"},showLevel:!1}},theme:"default",pdf:{pageNumbers:!0,fontSize:12,fontFamily:"Arial",paperSize:"a4",chapterMark:"pagebreak",pageBreaksBefore:"/",margin:{right:62,left:62,top:56,bottom:56}},structure:{langs:"LANGS.md",readme:"README.md",glossary:"GLOSSARY.md",summary:"SUMMARY.md"},variables:{},title:"Gulp Documentation",gitbook:"*",description:"Unofficial site for better reading experience of gulp documentation."},file:{path:"writing-a-plugin/README.md",mtime:"2016-07-06T13:48:43.000Z",type:"markdown"},gitbook:{version:"3.2.0",time:"2016-07-16T11:17:02.324Z"},basePath:"..",book:{language:""}})})</script></div><script src="../gitbook/gitbook.js"></script><script src="../gitbook/theme.js"></script><script src="../gitbook/plugins.js"></script></body></html>